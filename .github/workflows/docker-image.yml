name: Docker Image CI

# Trigger CI on pushes and pull requests to the main branch
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]


jobs:
  build:
    runs-on: ubuntu-latest  # Use latest Ubuntu runner for GitHub Actions

  steps:
    # Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v4

    # Log in to Docker Registry
    # Using secrets for security: DOCKER_USERNAME and DOCKER_PASSWORD must be added in GitHub Settings -> Secrets
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # Run tests before building
    # Prevents pushing broken images if tests fail
    - name: Run tests
      run: mvn test

    # Build and push Docker image with caching
    # Uses commit SHA for unique tag and "latest" for easy pulling
    # Leverages Docker layer caching for faster builds
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: . # Build context is the repository root
        file: ./Dockerfile  # Dockerfile path
        push: true  # Push image to Docker Hub
        tags: |
          my-image-name:${{ github.sha }}  #Tag with commit SHA
          my-image-name:latest  #Tag as latest
        cache-from: type=registry,ref=my-image-name:latest # Pull cache from latest image
        cache-to: type=registry,ref=my-image-name:latest,mode=max # Push cache back for next builds


          
